<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, shrink-to-fit=no">
    <title>客戶 - 訂單明細</title>
    <link rel="stylesheet" href="/assets/bootstrap/css/bootstrap.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/Swiper/6.4.8/swiper-bundle.min.css">
    <link rel="stylesheet" href="/assets/fonts/fontawesome-all.min.css">
</head>

<body style="height: 75px;margin-bottom: -580px;">
    <nav class="navbar navbar-light navbar-expand-md py-3" data-aos="zoom-in" data-aos-duration="1500">
        <div class="container">
            <a class="navbar-brand d-flex align-items-center" href="/index.html" style="position: sticky;top: 0;">
                <img width="75" height="41" src="/assets/img/logo-only.png">
            </a>

            <button data-bs-toggle="collapse" class="navbar-toggler" data-bs-target="#navcol-3"
                style="border-color: rgb(241,236,209);">
                <span class="visually-hidden">Toggle navigation</span>
                <span class="navbar-toggler-icon"
                    style="--bs-primary: #fd780f;--bs-primary-rgb: 253,120,15;--bs-secondary: #e69609;--bs-secondary-rgb: 230,150,9;color: rgb(241,236,209);">
                </span>
            </button>

            <div class="collapse navbar-collapse" id="navcol-3" style="background: #ffffff;">
                <ul class="navbar-nav mx-auto">
                    <li class="nav-item dropdown" style="width: 100px;margin: 0px 0px 0px 10px">
                        <a class="dropdown-toggle nav-link" aria-expanded="false" data-bs-toggle="dropdown"
                            data-bs-auto-close="outside" href="/index.html" style="margin: 10px 0px 0px;">關於我們</a>
                        <div class="dropdown-menu"
                            style="min-width: 110px;margin: 1px 0px 0px;border: 0px none rgba(33,37,41,0);">
                            <div class="dropdown-divider"
                                style="color: rgba(33,37,41,0);margin: 4px 0px;border-color: rgb(241,236,209);">
                            </div>
                            <a class="dropdown-item" href="#news-contain" style="font-size: 14px;">最新消息</a>
                            <a class="dropdown-item" href="#aboutMe-contain" style="font-size: 14px;">關於我們</a>
                        </div>
                    </li>

                    <li class="nav-item dropdown" style="width: 100px;margin: 0px 0px 0px 10px">
                        <a class="dropdown-toggle nav-link" aria-expanded="false" data-bs-toggle="dropdown"
                            data-bs-auto-close="outside" href="#" style="margin: 10px 0px 0px;">毛孩旅館</a>
                        <div class="dropdown-menu"
                            style="min-width: 110px;margin: 1px 0px 0px;border: 0px none rgba(33,37,41,0);">

                            <div class="dropdown-divider"
                                style="color: rgba(33,37,41,0);margin: 4px 0px;border-color: rgb(241,236,209);">
                            </div>
                            <a class="dropdown-item" href="/hotel/searchHotel.html" style="font-size: 14px">預約訂房</a>
                            <a class="dropdown-item join-hotelowner" href="/owner/SignUp.html"
                                style="font-size: 14px;color: #fd780f;">加入我們</a>
                        </div>
                    </li>

                    <li class="nav-item dropdown" style="width: 100px;margin: 0px 0px 0px 10px">
                        <a class="dropdown-toggle nav-link" aria-expanded="false" data-bs-toggle="dropdown"
                            data-bs-auto-close="outside" href="#" style="margin: 10px 0px 0px;">浪浪收容</a>
                        <div class="dropdown-menu"
                            style="min-width: 110px;margin: 1px 0px 0px;border: 0px none rgba(33,37,41,0);">
                            <div class="dropdown-divider"
                                style="color: rgba(33,37,41,0);margin: 4px 0px;border-color: rgb(241,236,209);">
                            </div>
                            <a class="dropdown-item" href="/animal_39/Frontanimal/animalbrowse.html"
                                style="font-size: 14px">浪浪認養</a>
                            <a class="dropdown-item lostPet" href="/lostPet/lost.html" style="font-size: 14px">遺失協尋</a>
                            <a class="dropdown-item" href="/animalCorporation/signup.html"
                                style="font-size: 14px">加入我們</a>
                        </div>
                    </li>

                    <li class="nav-item" style="height: 50px;width: 100px;margin: 0px 0px 0px 10px">
                        <a class="nav-link" href="/front-product-list/front-product-list.html"
                            style="width: 100px;margin: 10px 0px 0px;">寵物商城</a>
                    </li>

                    <!--          <li class="nav-item dropdown" style="width: 100px;margin: 0px 0px 0px 10px">-->
                    <!--            <a class="dropdown-toggle nav-link" aria-expanded="false" data-bs-toggle="dropdown"-->
                    <!--              data-bs-auto-close="outside" href="#" style="margin: 10px 0px 0px;" target="_parent">客服中心</a>-->
                    <!--            <div class="dropdown-menu" style="min-width: 110px;margin: 1px 0px 0px;border: 0px none rgba(33,37,41,0);">-->
                    <!--              <div class="dropdown-divider" style="color: rgba(33,37,41,0);margin: 4px 0px;border-color: rgb(241,236,209);">-->
                    <!--              </div>-->
                    <!--              <a class="dropdown-item" href="#" style="font-size: 14px">常見問題</a>-->
                    <!--              <a class="dropdown-item" href="#" style="font-size: 14px">服務認證</a>-->
                    <!--              <a class="dropdown-item" href="#" style="font-size: 14px">聯絡我們</a>-->
                    <!--            </div>-->
                    <!--          </li>-->

                </ul>

                <!-- Shopping Cart -->
                <div class="btn btn-primary cart"
                    style="cursor: pointer;margin-top: 10px;margin-right: 10px;border-style: none;background: rgb(255,255,255);color: #fd780f;height: 38px;width: 100px;">
                    <span class="fas fa-shopping-cart"
                        style="margin: 9px 5px 0px -12px;padding: 0px;font-size: 24px;color: #fd780f;height: 26px;width: 26px;margin-top: 0px;margin-right: 3px;margin-bottom: 3px;margin-left: 3px;">
                    </span>
                    <span class="shopping-cart-total"></span>
                </div>

                <!-- Member -->
                <div class="btn-group" style="margin: 10px 0px 0px;">
                    <a class="btn btn-primary" type="button"
                        style="height: 38px;width: 90px;background: #fd780f;border-color: rgb(255, 255, 255);padding-top: 6px">
                        <svg xmlns="http://www.w3.org/2000/svg" width="1em" height="1em" fill="currentColor"
                            viewBox="0 0 16 16" class="bi bi-person-circle"
                            style="margin: 0px 3px 3px;padding: 0px;font-size: 26px;">
                            <path d="M11 6a3 3 0 1 1-6 0 3 3 0 0 1 6 0z"></path>
                            <path fill-rule="evenodd"
                                d="M0 8a8 8 0 1 1 16 0A8 8 0 0 1 0 8zm8-7a7 7 0 0 0-5.468 11.37C3.242 11.226 4.805 10 8 10s4.757 1.225 5.468 2.37A7 7 0 0 0 8 1z">
                            </path>
                        </svg>會員
                    </a>
                    <button class="btn btn-primary dropdown-toggle dropdown-toggle-split" data-bs-toggle="dropdown"
                        aria-expanded="false" type="button"
                        style="background: #fd780f;border-color: rgb(255, 255, 255);width: 29.5833px;"></button>
                    <div class="dropdown-menu" style="min-width: 118px;background: #fd780f;margin: 1px 0px 0px;">
                        <a class="dropdown-item navigate-signin" href="#" style="color: #ffffff;">登入/註冊</a>
                        <a class="dropdown-item navigate-member-center" href="#" style="color: #ffffff;">會員中心</a>
                        <a class="dropdown-item logout" style="color: #ffffff;">登出</a>
                    </div>
                </div>

            </div>

        </div>
    </nav>
    <div class="container py-4 py-xl-5">
        <h1 style="font-weight: bold;text-align: center;">訂單明細</h1>
        <div class="row gy-4 gy-md-0">
            <div class="col-md-6 text-center text-md-start d-flex d-sm-flex d-md-flex
            justify-content-center align-items-center justify-content-md-start 
            align-items-md-center justify-content-xl-center" style="margin: 0px;">
                <div style="max-width:50%; margin-left: 100px;">
                    <h5><span id="order-status"></span></h5>
                    <h2 class="text-uppercase fw-bold"><span id="hotel-name"></span></h2>
                    <div class="my-3"><br>
                        <div>訂單編號: <span id="order-id"></span></div>
                        <div>訂單日期: <span id="order-date"></span></div>
                        <div>入住日期: <span id="check-in-date"></span></div>
                        <div>退房日期: <span id="check-out-date"></span></div>
                    </div>
                </div>
            </div>
            <div class="col-md-6">
                <div class="p-xl-5 m-xl-5">
                    <img class="rounded img-fluid w-100 fit-cover" id="room-image" style="min-height: 300px;">
                </div>
            </div>
        </div>
        <div style="width: 60%; margin-left: 23%;">
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0">客房資訊</h5>
                </div>
                <div class="card-body">
                    <div class="card-text">房型<span id="room-type-name" style="float: right;"></span></div>
                    <div class="card-text">特殊需求<span id="special-req" style="float: right;"></span></div>
                </div>
            </div>
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0">住客資訊</h5>
                </div>
                <div class="card-body">
                    <div class="card-text">寵物名稱<span id="pet-name" style="float: right;"></span></div>
                </div>
            </div>
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0">付款資訊</h5>
                </div>
                <div class="card-body">
                    <p class="card-text">
                        <span style="color: black;">付款方式</span>
                        <span id="payment-method" style="float: right;"></span><br>
                        <strong>
                            <span style="color: black;">總金額TWD</span>
                            <span id="price" style="float: right;"></span>
                        </strong>
                    </p>
                </div>
            </div>
        </div>
    </div>
    <script src="assets/bootstrap/js/bootstrap.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Swiper/6.4.8/swiper-bundle.min.js"></script>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <!-- <script src="assets/js/Simple-Slider.js"></script> -->
    <script src="../assets/js/login.js"></script>

    <script>
        $(document).ready(function () {
            guardIsSignedIn();
        });


        // Retrieve the order ID from the URL
        const urlParams = new URLSearchParams(window.location.search);
        const orderId = urlParams.get('id');

        // Fetch hotel name
        fetch(`/room-order/hotel-name/${orderId}`)
            .then(response => response.text())
            .then(data => {
                document.getElementById('hotel-name').textContent = data;
            })
            .catch(error => {
                console.error('Error:', error);
                // Handle error case
            });

        // Fetch order details
        fetch(`/room-order/id/${orderId}`)
            .then(response => response.json())
            .then(data => {
                // Update the HTML elements with the order information
                document.getElementById('order-id').textContent = data.id;
                document.getElementById('order-status').textContent = getStatusText(data.status);

                // Fetch additional member details
                const memberId = data.memId;
                const memberUrl = `/members/id=${memberId}`;
                fetch(memberUrl)
                    .then(response => response.json())
                    .then(memberData => {
                        document.getElementById('order-date').textContent = formatDateTime(data.orderDate);
                        document.getElementById('check-in-date').textContent = new Date(data.checkInDate).toLocaleDateString();
                        document.getElementById('check-out-date').textContent = new Date(data.checkOutDate).toLocaleDateString();

                        // Fetch room details
                        const roomTypeId = data.roomTypeId;
                        $.ajax({
                            url: `/roomTypes/${roomTypeId}`,
                            method: 'GET',
                            success: function (response) {
                                // Get room-type-name
                                $('#room-type-name').text(response.roomTypeName);
                            },
                            error: function (error) {
                                console.error('Error:', error);
                                // Handle error case
                            }
                        });

                        $.ajax({
                            url: `/roomTypes/${roomTypeId}/images`,
                            method: 'GET',
                            success: function (response) {
                                // Update the room image
                                var imageUrl = response[0];
                                var img = new Image();
                                img.onload = function () {
                                    // Image loaded successfully
                                    $('#room-image').attr('src', imageUrl);
                                };
                                img.onerror = function () {
                                    // Image failed to load, display substitute image
                                    $('#room-image').attr('src', '../assets/img/logo-only.png');
                                    $('#room-image').attr('alt', 'No Image Available');
                                };
                                img.src = imageUrl;
                            },
                            error: function (error) {
                                console.error('Error:', error);
                                // Handle error case
                            }
                        });

                        document.getElementById('special-req').textContent = data.specialReq;
                        document.getElementById('pet-name').textContent = data.petName;
                        document.getElementById('payment-method').textContent = getMethodText(data.payMethod);

                        // Calculate the total price of stay
                        const checkInDate = new Date(data.checkInDate);
                        const checkOutDate = new Date(data.checkOutDate);
                        const roomPrice = data.price;
                        const nights = Math.ceil((checkOutDate - checkInDate) / (1000 * 60 * 60 * 24)); // Calculate the number of nights
                        const totalPrice = roomPrice * nights;

                        // Update the room type price with additional text
                        const additionalText = ` x ${nights}晚 = ${totalPrice} 元`;
                        document.getElementById('price').textContent = data.price + additionalText;
                    })
                    .catch(error => {
                        console.error('Error fetching member details:', error);
                        // Handle error case for member details
                    });
            })
            .catch(error => {
                console.error('Error:', error);
                // Handle error case
            });


        // Function to format date and time and timezone
        function formatDateTime(dateTime) {
            const options = {
                year: 'numeric',
                month: '2-digit',
                day: '2-digit',
                hour: '2-digit',
                minute: '2-digit',
                second: '2-digit',
            };

            // Convert the dateTime to GMT+8
            const gmtDateTime = new Date(dateTime);
            gmtDateTime.setUTCHours(gmtDateTime.getUTCHours() + 8);

            return gmtDateTime.toLocaleString(options);
        }



        // Helper function to get the status text
        function getStatusText(status) {
            if (status === "0") {
                return "即將到來";
            } else if (status === "1") {
                return "已完成";
            } else if (status === "2") {
                return "已取消";
            } else {
                return "";
            }
        }

        // Helper function to get the payment method
        function getMethodText(method) {
            if (method === "0") {
                return "到店付款";
            } else if (method === "1") {
                return "信用卡結帳";
            } else {
                return "";
            }
        }


        // ------------------購物車項目初始化------------------
        let shoppingItem = sessionStorage.getItem("shoppingItem");
        if (shoppingItem) {
            shoppingItem = JSON.parse(shoppingItem);
        } else {
            shoppingItem = {};
        }

        // 更新購物車商品數
        function updateCartIcon() {
            let totalItems = 0;
            for (const productId in shoppingItem) {
                totalItems += shoppingItem[productId].quantity;
            }
            $(".shopping-cart-total").text(`(${totalItems})`);
        }

        // 初始化購物車圖示數量
        updateCartIcon();


        // ------------------前往購物車------------------
        $(".cart").on('click', function () {
            location.href = "/shopping/pd_page/Cart.html"
        });

    </script>

</body>

</html>